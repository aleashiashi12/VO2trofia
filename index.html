<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- T√çTULO ACTUALIZADO -->
    <title>VO2trofia - Entrenador Interactivo</title>
    
    <!-- === L√çNEAS PARA PWA === -->
    <meta name="theme-color" content="#111827">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <!-- === FIN DE L√çNEAS PWA === -->

    <!-- ... (El resto de tus comentarios de <head> no cambia) ... -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->

    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            background-color: #111827; /* bg-gray-900 */
        }
        .details-content {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .details-content.visible {
            max-height: 1000px;
            opacity: 1;
        }
        .timer-display {
            font-variant-numeric: tabular-nums; 
        }
        button {
            transition: all 0.2s ease-in-out;
        }
        ::selection {
            background-color: #6d28d9; /* violet-700 */
            color: white;
        }
        .progress-bar-container {
            width: 100%;
            background-color: #374151; /* gray-700 */
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress-bar {
            height: 10px;
            background-color: #a78bfa; /* violet-400 */
            width: 0%;
            transition: width 0.5s ease-out;
        }
        .whitespace-pre-line {
            white-space: pre-line;
        }
        .card {
            background-color: #1f2937; /* bg-gray-800 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(75, 85, 99, 0.5); /* border-gray-700/50 */
        }
        .day-card:hover {
            background-color: #374151; /* bg-gray-700 */
            transform: translateY(-0.25rem);
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen antialiased">

    <div class="container mx-auto max-w-4xl p-4 md:p-8">

        <!-- VISTA: SELECCI√ìN DE D√çA -->
        <div id="day-selector">
            <!-- T√çTULO ACTUALIZADO -->
            <h1 class="text-3xl md:text-4xl font-extrabold text-center mb-8 bg-clip-text text-transparent bg-gradient-to-r from-purple-500 to-indigo-500">
                VO2trofia
            </h1>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                
                <!-- Lunes -->
                <button id="btn-lunes" data-day="lunes" class="day-card text-left p-6 transition-all duration-300">
                    <span class="block text-sm font-semibold text-violet-400">LUNES üèãÔ∏è‚Äç‚ôÇÔ∏è</span>
                    <h2 class="text-xl font-bold mt-1">D√≠a 1: Torso (Empuje)</h2>
                    <p class="text-gray-400 text-sm mt-2">+ 10,000 pasos Zona 2</p>
                </button>

                <!-- Martes -->
                <button id="btn-martes" data-day="martes" class="day-card text-left p-6 transition-all duration-300">
                    <span class="block text-sm font-semibold text-violet-400">MARTES ü¶µ</span>
                    <h2 class="text-xl font-bold mt-1">D√≠a 2: Piernas y N√∫cleo</h2>
                </button>

                <!-- Mi√©rcoles (D√≠a de Descanso) - Inactivo -->
                <div class="card text-left p-6 cursor-default opacity-60">
                    <span class="block text-sm font-semibold text-teal-400">MI√âRCOLES üö∂‚Äç‚ôÇÔ∏è</span>
                    <h2 class="text-xl font-bold mt-1">Descanso Activo</h2>
                    <p class="text-gray-400 text-sm mt-2">Caminata Zona 1</p>
                </div>

                <!-- Jueves -->
                <button id="btn-jueves" data-day="jueves" class="day-card text-left p-6 transition-all duration-300">
                    <span class="block text-sm font-semibold text-violet-400">JUEVES üèãÔ∏è‚Äç‚ôÇÔ∏è</span>
                    <h2 class="text-xl font-bold mt-1">D√≠a 3: Torso (Tracci√≥n)</h2>
                    <p class="text-gray-400 text-sm mt-2">+ 10,000 pasos Zona 2</p>
                </button>

                <!-- Viernes -->
                <button id="btn-viernes" data-day="viernes" class="day-card text-left p-6 transition-all duration-300">
                    <span class="block text-sm font-semibold text-red-400">VIERNES üî•</span>
                    <h2 class="text-xl font-bold mt-1">Sesi√≥n HIIT 4x4</h2>
                </button>

                <!-- S√°bado -->
                <button id="btn-sabado" data-day="sabado" class="day-card text-left p-6 transition-all duration-300">
                    <span class="block text-sm font-semibold text-violet-400">S√ÅBADO üí™</span>
                    <h2 class="text-xl font-bold mt-1">D√≠a 4: Cuerpo Completo</h2>
                    <p class="text-gray-400 text-sm mt-2">Funcional</p>
                </button>

                <!-- Domingo (D√≠a de Descanso) - Inactivo -->
                <div class="card text-left p-6 cursor-default opacity-60">
                    <span class="block text-sm font-semibold text-teal-400">DOMINGO üö∂‚Äç‚ôÇÔ∏è</span>
                    <h2 class="text-xl font-bold mt-1">Descanso Activo</h2>
                    <p class="text-gray-400 text-sm mt-2">Caminata Zona 1</p>
                </div>
            </div>
        </div>

        <!-- VISTA: ENTRENAMIENTO (Contenedor principal) -->
        <div id="workout-stepper" class="hidden">
            <button id="back-to-menu" class="mb-6 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm font-medium transition-colors">
                &larr; Volver al Men√∫
            </button>
            
            <h1 id="workout-title" class="text-3xl font-bold text-center bg-clip-text text-transparent bg-gradient-to-r from-purple-500 to-indigo-500 mb-4"></h1>
            <p id="step-progress" class="text-center text-gray-400 mb-4 font-medium"></p>

            <!-- VISTA PASO A PASO (Tarjeta Est√°ndar) -->
            <div id="step-content" class="card p-6 md:p-8 w-full max-w-2xl mx-auto">
                <h2 id="step-title" class="text-2xl font-bold text-white mb-4"></h2>
                <p id="step-details" class="text-lg text-gray-300 mb-6"></p>

                <!-- Temporizador de Duraci√≥n (para Ejercicios por tiempo) -->
                <div id="duration-timer-block" class="hidden text-center mb-6">
                    <p class="text-gray-400 text-sm">Tiempo restante para este paso:</p>
                    <div id="duration-timer-display" class="text-5xl font-extrabold text-teal-400 my-2 timer-display">00:00</div>
                    <div class="flex justify-center gap-4">
                        <button id="toggle-duration-timer" class="px-6 py-3 bg-teal-600 hover:bg-teal-500 rounded-lg font-bold transition-colors w-40 shadow-lg shadow-teal-500/20">
                            Iniciar
                        </button>
                        <button id="skip-duration-timer" class="px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg font-bold transition-colors shadow-lg">
                            Saltar Parte
                        </button>
                    </div>
                </div>

                <!-- Bloques de Informaci√≥n (T√©cnica, Progresi√≥n) -->
                <div class=""> 
                    <div id="technique-block" class="hidden">
                        <button id="toggle-technique" class="text-sm font-semibold text-violet-400 hover:text-violet-300 transition-colors">
                            Mostrar T√©cnica &darr;
                        </button>
                        <div id="technique-content" class="details-content bg-gray-900/50 p-4 rounded-lg mt-2 text-gray-200 text-sm leading-relaxed whitespace-pre-line border border-gray-700/50">
                        </div>
                    </div>
                    
                    <div id="progression-block" class="hidden">
                        <button id="toggle-progression" class="text-sm font-semibold text-indigo-300 hover:text-indigo-200 transition-colors">
                            Mostrar Progresi√≥n &darr;
                        </button>
                        <div id="progression-content" class="details-content bg-gray-900/50 p-4 rounded-lg mt-2 text-gray-200 text-sm leading-relaxed whitespace-pre-line border border-gray-700/50">
                        </div>
                    </div>

                    <div id="skip-exercise-block" class="hidden text-center pt-2 border-t border-gray-700/50"> 
                        <button id="skip-exercise-btn" class="text-sm font-semibold text-gray-500 hover:text-red-400 transition-colors">
                            Saltar este ejercicio &rarr;
                        </button>
                    </div>
                </div>
            </div>

            <!-- VISTA DE CALENTAMIENTO CONTINUO -->
            <div id="continuous-warmup-view" class="hidden card p-6 md:p-8 w-full max-w-2xl mx-auto">
                <div class="mb-4">
                    <p id="warmup-progress-text" class="text-sm text-gray-400 mb-1">Calentamiento: (Paso 1 de X)</p>
                    <div class="progress-bar-container">
                        <div id="warmup-progress-bar" class="progress-bar"></div>
                    </div>
                </div>

                <h2 id="warmup-step-status" class="text-2xl font-bold text-center text-green-400 mb-2">¬°Prep√°rate! ‚è±Ô∏è</h2>
                
                <div id="warmup-step-timer-display" class="text-6xl font-extrabold text-center text-white my-4 timer-display">00:03</div>

                <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700/50 min-h-[170px]">
                    <h3 id="warmup-step-name" class="text-xl font-bold text-white mb-2">...</h3>
                    <p id="warmup-step-details" class="text-gray-300">...</p>
                    
                    <h4 class="text-sm font-semibold text-violet-300 mt-3">C√≥mo Hacerlo:</h4>
                    <p id="warmup-step-cue" class="text-white font-medium">...</p>
                </div>

                <div class="flex justify-center gap-4 mt-8">
                    <button id="warmup-toggle-pause" class="px-8 py-3 bg-yellow-600 hover:bg-yellow-500 rounded-lg font-bold text-gray-900 transition-colors shadow-lg shadow-yellow-500/20 w-36">
                        Pausar
                    </button>
                    <button id="warmup-skip-all" class="px-8 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg font-bold transition-colors shadow-lg">
                        Saltar Calentamiento
                    </button>
                </div>
            </div>

            <!-- VISTA HIIT (Tarjeta Especial) -->
            <div id="hiit-workout-view" class="hidden card p-6 md:p-8 w-full max-w-2xl mx-auto mt-8">
                <h2 class="text-3xl font-extrabold text-red-400 text-center mb-4">¬°HIIT: El Complejo! üî•</h2>
                <p id="hiit-round-info" class="text-center text-gray-300 text-lg mb-6">Ronda 1 de 4: Trabajo</p>

                <div class="text-center mb-6">
                    <p class="text-gray-400 text-sm">Tiempo restante:</p>
                    <div id="hiit-timer-display" class="text-6xl md:text-7xl font-extrabold text-red-500 my-2 timer-display">00:00</div>
                </div>

                <div class="flex justify-center gap-4 mb-8">
                    <button id="hiit-start-pause-btn" class="px-8 py-4 bg-red-600 hover:bg-red-500 rounded-lg font-bold text-xl transition-colors shadow-lg shadow-red-500/20">
                        Iniciar HIIT
                    </button>
                </div>

                <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700/50">
                    <h3 class="text-xl font-bold text-white mb-3">El Complejo: (Repetir)</h3>
                    <ul id="hiit-exercises-list" class="list-disc list-inside text-gray-200 text-lg space-y-2">
                    </ul>
                    <p class="text-gray-400 text-sm mt-4">Peso sugerido: Barra vac√≠a (5 kg) o 10 kg.</p>
                </div>
            </div>

            <!-- VISTA DE DESCANSO -->
            <div id="rest-timer-block" class="hidden card p-6 md:p-8 w-full max-w-2xl mx-auto">
                <p class="text-lg text-center text-gray-300 mb-4">Siguiente: <strong id="rest-next-exercise" class="text-white"></strong></p>
                <p class="text-gray-400 text-sm text-center">Tiempo de descanso:</p>
                <div id="rest-timer-display" class="text-6xl font-extrabold text-red-400 my-4 text-center timer-display">00:00</div>
                <div class="flex justify-center gap-4">
                    <button id="toggle-rest-timer" class="px-6 py-3 bg-red-600 hover:bg-red-500 rounded-lg font-bold transition-colors w-40 shadow-lg shadow-red-500/20">
                        Pausar
                    </button>
                    <button id="skip-rest-timer" class="px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg font-bold transition-colors shadow-lg">
                        Saltar Descanso
                    </button>
                </div>
            </div>


            <!-- Navegaci√≥n (Anterior/Siguiente) -->
            <div id="step-navigation" class="flex justify-between max-w-2xl mx-auto mt-8">
                <button id="prev-step" class="px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg font-bold transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Anterior
                </button>
                <button id="next-step" class="px-6 py-3 bg-indigo-600 hover:bg-indigo-500 rounded-lg font-bold text-white transition-colors shadow-lg shadow-indigo-500/30">
                    Siguiente Paso
                </button>
            </div>
        </div>

        <!-- MODAL DE CONFIRMACI√ìN DE SALTO -->
        <div id="skip-confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="card p-6 w-full max-w-sm text-center">
                <h3 class="text-xl font-bold text-yellow-400 mb-4">¬øConfirmar Salto? ‚ö†Ô∏è</h3>
                <p class="text-gray-300 mb-6">¬øEst√°s seguro de que quieres saltar el calentamiento?</p>
                <div class="flex justify-center gap-4">
                    <button id="confirm-skip-no" class="px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg font-bold transition-colors w-full">
                        No, Continuar
                    </button>
                    <button id="confirm-skip-yes" class="px-6 py-3 bg-red-600 hover:bg-red-500 rounded-lg font-bold transition-colors w-full shadow-lg shadow-red-500/20">
                        S√≠, Saltar
                    </button>
                </div>
            </div>
        </div>

        <!-- MODAL DE FINALIZACI√ìN DE RUTINA -->
        <div id="completion-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="card p-8 w-full max-w-sm text-center">
                <span class="text-6xl mb-4 block">üèÜ</span>
                <h3 id="completion-title" class="text-2xl font-bold text-green-400 mb-3">¬°Rutina Completada!</h3>
                <p id="completion-message" class="text-gray-300 text-lg mb-8">¬°Excelente trabajo!</p>
                <button id="close-completion-modal" class="w-full px-6 py-3 bg-indigo-600 hover:bg-indigo-500 rounded-lg font-bold text-white transition-colors shadow-lg shadow-indigo-500/30">
                    Volver al Men√∫
                </button>
            </div>
        </div>

    </div>

    
    <script>
        
        const allData = {
            warmUps: {
                fuerza: [
                    { type: 'warmup', name: 'Elevaci√≥n del Ritmo Card√≠aco', details: '2 minutos de carrera en el sitio o saltos de tijera.', duration: 120, transition: 3, cue: 'Trote ligero en el sitio. Eleva las rodillas alternadamente.' },
                    { type: 'warmup', name: 'Movilidad de Hombros', details: 'C√≠rculos grandes y controlados con los brazos. (30s Total)', duration: 30, transition: 3, cue: '...', 
                      parts: [
                        { name: '(Adelante)', duration: 15, cue: 'Brazos rectos. Dibuja c√≠rculos grandes y lentos hacia adelante.'},
                        { name: '(Atr√°s)', duration: 15, cue: 'Cambia de direcci√≥n. Brazos rectos, c√≠rculos atr√°s.'}
                      ]},
                    { type: 'warmup', name: 'Movilidad de Columna', details: '30 segundos de rotaciones de torso, de pie.', duration: 30, transition: 3, cue: 'Pies fijos al ancho de hombros. Gira el torso (no la cadera) de lado a lado.' },
                    { type: 'warmup', name: 'Movilidad de Cadera (C√≠rculos)', details: '10 c√≠rculos hacia afuera con cada pierna. (40s Total)', duration: 40, transition: 3, cue: '...',
                      parts: [
                        { name: '(Pierna Izquierda)', duration: 20, cue: 'Ap√≥yate. Sube rodilla izq, √°brela hacia afuera y abajo.'},
                        { name: '(Pierna Derecha)', duration: 20, cue: 'Cambia de pierna. Sube rodilla der, √°brela.'}
                      ]},
                    { type: 'warmup', name: 'Movilidad de Cadera (Balanceos)', details: '10 balanceos adelante/atr√°s y lado/lado con cada pierna. (40s Total)', duration: 40, transition: 3, cue: '...',
                      parts: [
                        { name: '(Pierna Izquierda)', duration: 20, cue: 'Ap√≥yate. Con pierna izq estirada, balanc√©ala adelante y atr√°s.'},
                        { name: '(Pierna Derecha)', duration: 20, cue: 'Cambia de pierna. Pierna der estirada, balanc√©ala.'}
                      ]},
                    { type: 'warmup', name: 'Activaci√≥n de Patr√≥n', details: '15 repeticiones de sentadillas con peso corporal, lentas y profundas. (Aprox. 45 segundos)', duration: 45, transition: 3, cue: 'Imagina una silla. Cadera atr√°s, espalda recta. Baja profundo y sube controlado.' },
                    { type: 'warmup', name: 'Activaci√≥n Din√°mica', details: '5 estocadas con torsi√≥n por cada lado. (40s Total)', duration: 40, transition: 3, cue: '...',
                      parts: [
                        { name: '(Lado Izquierdo)', duration: 20, cue: 'Da un paso largo (zancada) con la izq. Gira tu torso hacia la izquierda.'},
                        { name: '(Lado Derecho)', duration: 20, cue: 'Alterna. Paso largo con la der. Gira tu torso a la derecha.'}
                      ]},
                ],
                hiit: [
                    { type: 'warmup', name: 'Jumping Jacks', details: 'Comenzamos a elevar el ritmo card√≠aco.', duration: 45, transition: 3, cue: 'Salta abriendo piernas y subiendo brazos. Salta cerrando todo.' },
                    { type: 'warmup', name: 'Correr en el Sitio / Rodillas Altas', details: 'Mant√©n el ritmo, rodillas arriba.', duration: 45, transition: 3, cue: 'Ritmo r√°pido. Sube las rodillas lo m√°s alto que puedas, alterna brazos.' },
                    { type: 'warmup', name: 'Sentadillas con Peso Corporal', details: 'Baja profundo, movimiento controlado.', duration: 30, transition: 3, cue: 'Cadera atr√°s, pecho erguido. Baja hasta que la cadera supere las rodillas.' },
                    { type: 'warmup', name: 'Burpees (sin flexi√≥n/salto)', details: 'Plancha, vuelve y de pie. Ritmo constante.', duration: 30, transition: 3, cue: 'Ag√°chate, manos al suelo. Salta con pies a plancha. Salta con pies a manos. Lev√°ntate.' },
                    { type: 'warmup', name: 'Recuperar', details: 'Respira. El siguiente bloque es movilidad.', duration: 15, transition: 3, cue: 'Respira profundo, camina un poco.' },
                    { type: 'warmup', name: 'Balanceos de Piernas (Frontal/Atr√°s)', details: '10 por pierna. Ap√≥yate si es necesario. (40s Total)', duration: 40, transition: 3, cue: '...',
                      parts: [
                        { name: '(Pierna Izquierda)', duration: 20, cue: 'Ap√≥yate. Pierna izq estirada. Balanc√©ala de adelante (patada) hacia atr√°s.'},
                        { name: '(Pierna Derecha)', duration: 20, cue: 'Cambia de pierna. Pierna der estirada, balanc√©ala.'}
                      ]},
                    { type: 'warmup', name: 'C√≠rculos con los Brazos', details: '15s hacia adelante, 15s hacia atr√°s. Grandes. (30s Total)', duration: 30, transition: 3, cue: '...',
                      parts: [
                        { name: '(Adelante)', duration: 15, cue: 'Brazos rectos. Dibuja c√≠rculos amplios. 15s adelante.'},
                        { name: '(Atr√°s)', duration: 15, cue: 'Cambia de direcci√≥n. 15s atr√°s.'}
                      ]},
                    { type: 'warmup', name: 'Sentadilla Profunda con Rotaci√≥n', details: '5 por lado. Baja, codo a rodilla, rota abriendo el pecho. (40s Total)', duration: 40, transition: 3, cue: '...',
                      parts: [
                        { name: '(Lado Izquierdo)', duration: 20, cue: 'En cuclillas. Codo der en rodilla der. Gira y abre pecho izq al techo.'},
                        { name: '(Lado Derecho)', duration: 20, cue: 'Cambia de lado. Codo izq en rodilla izq. Gira y abre pecho der.'}
                      ]},
                    { type: 'warmup', name: 'Toma la Barra (Vac√≠a)', details: 'Prepara la barra vac√≠a (5kg). El √∫ltimo bloque.', duration: 10, transition: 3, cue: 'Posici√≥nate con la barra vac√≠a.' },
                    { type: 'warmup', name: '5 Sentadillas Frontales', details: 'Lento y controlado. Codos arriba.', duration: 15, transition: 3, cue: 'Barra sobre hombros, codos apuntando al frente. Baja profundo (sentadilla).' },
                    { type: 'warmup', name: '5 Press Estricto', details: 'Aprieta abdomen. Empuja sobre la cabeza.', duration: 15, transition: 3, cue: 'Barra en hombros. Aprieta abdomen/gl√∫teos. Empuja la barra recto sobre tu cabeza.' },
                    { type: 'warmup', name: '5 Push Press', details: 'Ligero impulso de piernas.', duration: 15, transition: 3, cue: 'Ligera flexi√≥n de rodillas (dip). Extiende caderas y piernas, usa ese impulso para empujar la barra arriba.' },
                    { type: 'warmup', name: '5 Thrusters', details: 'Sentadilla + Empuje. Controlado.', duration: 20, transition: 3, cue: 'Haz una sentadilla frontal completa. Al subir, explota y usa el impulso para hacer un Push Press.' }
                ]
            },
            days: {
                lunes: {
                    dayName: "Lunes",
                    title: "D√≠a 1: Torso (Empuje) üèãÔ∏è‚Äç‚ôÇÔ∏è",
                    warmUpType: "fuerza",
                    steps: [
                        { type: 'exercise', name: 'Press Militar con Barra (de pie)', sets: 4, reps: '6-10', rest: 90, 
                          technique: `1. **Posici√≥n Inicial:** Coloca la barra en el suelo. C√°rgala con un peso ligero. Ponte en cuclillas y lev√°ntala hasta tus hombros (posici√≥n de front squat/clean).
2. **Agarre:** Sujeta la barra un poco m√°s ancha que tus hombros, con las palmas mirando hacia adelante. Los codos deben apuntar ligeramente al frente.
3. **N√∫cleo:** De pie, con los pies a la anchura de los hombros, aprieta fuertemente el abdomen y los gl√∫teos. Esto es clave para proteger tu espalda.
4. **Empuje:** Respira hondo y empuja la barra recto hacia el techo. La barra debe pasar cerca de tu cara. Al final, "mete" la cabeza ligeramente hacia adelante para que la barra quede alineada sobre tu columna y hombros, con los brazos totalmente extendidos.
5. **Descenso:** Baja la barra de forma controlada, rozando tu barbilla, hasta que descanse de nuevo sobre la parte alta de tu pecho/hombros. Repite.`, 
                          progression: 'Cuando completes 10 reps en todas las series, aumenta el peso (a√±ade discos peque√±os).' },
                        
                        { type: 'exercise', name: 'Flexiones con Chaleco Lastrado', sets: 4, reps: '8-15', rest: 90, 
                          technique: `1. **Preparaci√≥n:** Ponte el chaleco de 10 kg y aj√∫stalo bien.
2. **Posici√≥n Inicial:** Col√≥cate en posici√≥n de plancha alta (manos en el suelo, brazos extendidos), con las manos un poco m√°s ancha que tus hombros.
3. **Alineaci√≥n:** Tu cuerpo debe formar una l√≠nea recta desde la cabeza hasta los talones. Aprieta el abdomen y los gl√∫teos. No dejes que tu cadera se hunda ni se eleve.
4. **Descenso:** Dobla los codos (apuntando ligeramente hacia atr√°s, no 90 grados hacia los lados) y baja el pecho hasta que casi toque el suelo.
5. **Empuje:** Empuja el suelo con fuerza para volver a la posici√≥n inicial, extendiendo los brazos por completo.`, 
                          progression: 'Aumenta las repeticiones. Si llegas a 15 reps en todas las series, prueba progresiones como pies elevados sobre la caja.' },
                        
                        { type: 'exercise', name: 'Fondos en Sillas (con Chaleco Lastrado)', sets: 3, reps: '8-15', rest: 75, 
                          technique: `1. **Preparaci√≥n:** Ponte el chaleco de 10 kg. Necesitar√°s tu caja o una silla muy estable.
2. **Posici√≥n:** Si√©ntate en el borde de la caja/silla. Coloca las manos en el borde a cada lado de tu cadera, con los dedos apuntando hacia adelante.
3. **Inicio:** Desliza tu trasero fuera de la caja. Apoya tu peso en tus manos. Puedes dejar las piernas flexionadas (m√°s f√°cil) o estiradas (m√°s dif√≠cil).
4. **Descenso:** Dobla los codos (apuntando recto hacia atr√°s) y baja tu cuerpo hasta que tus hombros est√©n a la altura de tus codos (formando 90 grados). Mant√©n el pecho erguido y la espalda cerca de la caja.
5. **Empuje:** Empuja con la palma de tus manos, concentr√°ndote en estirar los tr√≠ceps (la parte trasera del brazo) para volver a la posici√≥n inicial.`, 
                          progression: 'Aumenta las repeticiones. Si lo haces con piernas flexionadas, prueba a estirarlas.' },
                        
                        { type: 'exercise', name: 'Press Franc√©s en Suelo con Barra', sets: 3, reps: '8-12', rest: 60, 
                          technique: `1. **Posici√≥n Inicial:** T√∫mbate boca arriba en el suelo. Dobla las rodillas y apoya los pies en el suelo para estabilizar la espalda.
2. **Agarre:** Sujeta la barra (puedes usar la barra sola o con discos peque√±os) con un agarre estrecho (manos a unos 15-20 cm de distancia).
3. **Inicio:** Extiende los brazos rectos sobre tu pecho, perpendicular al suelo.
4. **Descenso:** Manteniendo los codos fijos y apuntando al techo, dobla *√∫nicamente* los codos para bajar la barra lentamente hacia tu frente o justo por encima de tu cabeza.
5. **Extensi√≥n:** Sin mover la parte superior de tus brazos, extiende los codos para volver a subir la barra, apretando con fuerza los tr√≠ceps. Los codos no deben abrirse hacia los lados.`, 
                          progression: 'Aumenta el peso en la barra (discos peque√±os).' },
                        
                        { type: 'exercise', name: 'Elevaciones Laterales (con discos)', sets: 3, reps: '12-20', rest: 60, 
                          technique: `1. **Posici√≥n Inicial:** De pie, con los pies firmes. Sost√©n un disco de peso ligero (ej. 2.5 kg o 5 kg) en cada mano, con las palmas mirando hacia tu cuerpo.
2. **Postura:** Mant√©n una ligera flexi√≥n en los codos, como si abrazaras un barril grande.
3. **Elevaci√≥n:** Sin usar impulso ni balancear el cuerpo, levanta los brazos hacia los lados. Imagina que empujas las paredes.
4. **Pico:** Sube solo hasta que tus manos est√©n a la altura de tus hombros (brazos paralelos al suelo). Aprieta un segundo.
5. **Descenso:** Baja los discos de forma lenta y controlada. No dejes que simplemente caigan.`, 
                          progression: 'Aumenta las repeticiones. Conc√©ntrate en la lentitud del movimiento.' }
                    ],
                    final: { type: 'cardio', name: 'Cardio Ligero (Zona 2)', details: 'Realizar 10,000 pasos a lo largo del d√≠a (caminata).' }
                },
                martes: {
                    dayName: "Martes",
                    title: "D√≠a 2: Piernas y N√∫cleo ü¶µ",
                    warmUpType: "fuerza",
                    steps: [
                        { type: 'exercise', name: 'Sentadilla con Barra', sets: 4, reps: '6-10', rest: 120, 
                          technique: `1. **Levantar la Barra (sin rack):** Carga la barra en el suelo. Lev√°ntala primero a tus hombros (como en el Press Militar) y luego, con cuidado, emp√∫jala sobre tu cabeza y d√©jala descansar sobre tus trapecios (m√∫sculos del cuello/espalda), NO sobre las v√©rtebras del cuello.
2. **Posici√≥n:** Pies a la anchura de los hombros, puntas ligeramente hacia afuera. Pecho erguido, mirada al frente.
3. **Descenso:** Inicia el movimiento empujando la cadera hacia atr√°s y luego doblando las rodillas, como si fueras a sentarte en una silla. Mant√©n la espalda recta.
4. **Profundidad:** Baja hasta que tu cadera est√© por debajo de tus rodillas (romper el paralelo). Aseg√∫rate de que tus rodillas sigan la direcci√≥n de tus pies (que no se metan hacia adentro).
5. **Ascenso:** Empuja el suelo con toda la planta del pie (especialmente talones) para subir. Aprieta los gl√∫teos al llegar arriba.`, 
                          progression: 'Aumenta el peso cuando completes 10 reps en todas las series.' },
                        
                        { type: 'exercise', name: 'Peso Muerto Rumano con Barra', sets: 4, reps: '8-12', rest: 90, 
                          technique: `1. **Posici√≥n Inicial:** De pie, con la barra en tus manos y un agarre a la anchura de los hombros. Tus pies est√°n a la anchura de la cadera.
2. **Postura:** Mant√©n una *ligera* flexi√≥n en las rodillas (casi rectas, pero no bloqueadas). Espalda completamente recta y pecho erguido.
3. **Descenso:** Empuja tu cadera *hacia atr√°s* como si quisieras tocar la pared de atr√°s con el trasero. La barra debe deslizarse por tus muslos y espinillas.
4. **L√≠mite:** Baja hasta que sientas un fuerte estiramiento en los isquiotibiales (parte trasera de la pierna), o hasta que tu espalda empiece a redondearse (¬°no la redondees!).
5. **Ascenso:** Invierte el movimiento. Empuja la cadera *hacia adelante* y aprieta los gl√∫teos con fuerza para volver a la posici√≥n inicial.`, 
                          progression: 'Aumenta el peso en la barra.' },
                        
                        { type: 'exercise', name: 'Zancadas (con Barra o Chaleco)', sets: 3, reps: '8-12 por pierna', rest: 75, 
                          technique: `1. **Preparaci√≥n:** Ponte el chaleco de 10 kg o coloca la barra sobre tus trapecios (como en la sentadilla).
2. **Paso:** Da un paso largo hacia adelante.
3. **Descenso:** Baja el cuerpo de forma vertical hasta que tu rodilla trasera est√© casi tocando el suelo. Ambas rodillas deben formar √°ngulos de 90 grados.
4. **Estabilidad:** Mant√©n el torso erguido y el abdomen apretado. El peso debe estar en el tal√≥n de tu pie delantero.
5. **Ascenso:** Empuja con fuerza con el pie delantero para volver a la posici√≥n inicial. Alterna la pierna en cada repetici√≥n.`, 
                          progression: 'Aumenta el peso (en la barra) o las repeticiones.' },
                        
                        { type: 'exercise', name: 'Hip Thrust con Barra', sets: 4, reps: '10-15', rest: 75, 
                          technique: `1. **Posici√≥n:** Si√©ntate en el suelo con la parte superior de tu espalda (justo debajo de los om√≥platos) apoyada contra el borde de tu caja.
2. **Colocar la Barra:** Rueda la barra (con discos) sobre tus piernas hasta que quede justo sobre tu cadera. Puedes usar una toalla doblada debajo de la barra si te molesta.
3. **Inicio:** Dobla las rodillas y apoya los pies en el suelo.
4. **Empuje:** Empuja con los talones y levanta la cadera del suelo. Tu cuerpo debe formar una l√≠nea recta desde tus hombros (en la caja) hasta tus rodillas.
5. **Contracci√≥n:** Aprieta los gl√∫teos con todas tus fuerzas en la parte alta. Mant√©n la barbilla pegada al pecho.
6. **Descenso:** Baja la cadera de forma controlada casi hasta el suelo y repite.`, 
                          progression: 'Aumenta el peso en la barra.' },
                        
                        { type: 'exercise', name: 'Plancha con Chaleco Lastrado', sets: 3, reps: '45-75 segundos', rest: 60, 
                          technique: `1. **Preparaci√≥n:** Ponte el chaleco de 10 kg.
2. **Posici√≥n:** T√∫mbate boca abajo y apoya tu peso sobre tus antebrazos y las puntas de tus pies. Los codos deben estar justo debajo de los hombros.
3. **Alineaci√≥n Perfecta:** Tu cuerpo debe ser una tabla. Aprieta el abdomen (como si fueras a recibir un golpe) y los gl√∫teos.
4. **Clave:** No dejes que tu cadera se hunda hacia el suelo ni que tu trasero se levante. Mira al suelo para mantener el cuello alineado. Aguanta esa posici√≥n.`, 
                          progression: 'Aumenta la duraci√≥n. Si llegas a 75s, puedes probar a levantar un pie del suelo por turnos.' }
                    ]
                },
                miercoles: {
                    dayName: "Mi√©rcoles",
                    title: "Descanso Activo (Zona 1) üö∂‚Äç‚ôÇÔ∏è",
                    warmUpType: null,
                    steps: [
                        { type: 'activity', name: 'Caminata Ligera (Zona 1)', details: 'Caminata ligera para recuperaci√≥n.', duration: 3600 } 
                    ]
                },
                jueves: {
                    dayName: "Jueves",
                    title: "D√≠a 3: Torso (Tracci√≥n) üèãÔ∏è‚Äç‚ôÇÔ∏è",
                    warmUpType: "fuerza",
                    steps: [
                        { type: 'exercise', name: 'Remo con Barra', sets: 4, reps: '6-10', rest: 90, 
                          technique: `1. **Posici√≥n Inicial:** De pie, con la barra en el suelo. Inclina tu torso hacia adelante desde la cadera, manteniendo la espalda *completamente recta*. El torso debe quedar a unos 45 grados (o casi paralelo al suelo).
2. **Agarre:** Sujeta la barra con las palmas mirando hacia tu cuerpo, un poco m√°s ancho que tus hombros.
3. **Tir√≥n (Remo):** Tira de la barra hacia tu abdomen. Inicia el movimiento "remando" con los codos y apretando los om√≥platos (juntando las paletillas).
4. **Pico:** La barra debe tocar tu est√≥mago o la parte baja del pecho. Aprieta la espalda.
5. **Descenso:** Baja la barra de forma controlada hasta que tus brazos est√©n completamente extendidos, sin perder la postura de la espalda.`, 
                          progression: 'Aumenta el peso en la barra.' },
                        
                        { type: 'exercise', name: 'Dominadas (con Chaleco si es posible)', sets: 4, reps: 'al fallo', rest: 90, 
                          technique: `(Se asume que tienes una barra de dominadas en casa).
1. **Preparaci√≥n:** Si ya puedes hacer 8-10 dominadas limpias, ponte el chaleco de 10 kg. Si no, hazlas con tu peso corporal.
2. **Agarre:** Sujeta la barra con las palmas mirando *hacia afuera* (agarre prono), un poco m√°s ancho que tus hombros.
3. **Inicio:** Cuelga de la barra con los brazos completamente extendidos.
4. **Tir√≥n:** Inicia el movimiento retrayendo los hombros (juntando om√≥platos) y tira de tu cuerpo hacia arriba, pensando en llevar el pecho a la barra.
5. **Pico:** Sube hasta que tu barbilla sobrepase claramente la barra.
6. **Descenso:** Baja de forma controlada (no te dejes caer) hasta que tus brazos est√©n rectos de nuevo.`, 
                          progression: 'Aumenta las repeticiones totales. Si haces m√°s de 12-15 sin chaleco, a√±ade el chaleco.' },
                        
                        { type: 'exercise', name: 'Remo Invertido', sets: 3, reps: '8-15', rest: 75, 
                          technique: `1. **Preparaci√≥n:** Coloca la barra vac√≠a sobre dos sillas estables (o usa el borde de una mesa muy resistente).
2. **Posici√≥n:** M√©tete debajo de la barra/mesa. Suj√©tala con las palmas hacia ti (supino) o hacia afuera (prono), a la anchura de los hombros.
3. **Alineaci√≥n:** Forma una l√≠nea recta desde tus talones hasta tu cabeza, apoy√°ndote solo en los talones. Aprieta abdomen y gl√∫teos.
4. **Tir√≥n:** Tira de tu pecho hacia la barra/mesa, apretando los om√≥platos.
5. **Descenso:** Baja controlado.
**Dificultad:** Cuanto m√°s horizontal est√©s (pies m√°s lejos), m√°s dif√≠cil. Si flexionas las rodillas, es m√°s f√°cil.`, 
                          progression: 'Aumenta las repeticiones. Para m√°s dificultad, estira las piernas o el√©valas sobre otra silla/caja.' },
                        
                        { type: 'exercise', name: 'Curl de B√≠ceps con Barra', sets: 3, reps: '8-12', rest: 60, 
                          technique: `1. **Posici√≥n:** De pie, con la espalda recta y el abdomen apretado. Sujeta la barra con las palmas mirando *hacia arriba* (agarre supino), a la anchura de tus hombros.
2. **Codos Fijos:** Fija tus codos a los costados de tu cuerpo. NO deben moverse hacia adelante o atr√°s durante el ejercicio.
3. **Subida:** Dobla los codos para levantar la barra hacia tus hombros. Aprieta los b√≠ceps con fuerza en la parte alta. No uses la espalda ni el impulso para balancear la barra.
4. **Descenso:** Baja la barra de forma lenta y controlada hasta que tus brazos est√©n casi completamente extendidos. Siente el estiramiento.`, 
                          progression: 'Aumenta el peso en la barra.' },
                        
                        { type: 'exercise', name: 'Plancha Lateral', sets: 3, reps: '30-45 segundos por lado', rest: 45, 
                          technique: `1. **Posici√≥n:** T√∫mbate de lado en el suelo.
2. **Apoyo:** Apoya tu peso sobre tu antebrazo (codo justo debajo del hombro) y el borde exterior de tu pie de abajo.
3. **Alineaci√≥n:** Levanta la cadera del suelo hasta que tu cuerpo forme una l√≠nea recta perfecta desde la cabeza hasta los pies.
4. **Clave:** No dejes que la cadera se caiga. Aprieta los abdominales oblicuos (el costado). Puedes poner la mano libre en tu cadera o extenderla al techo.`, 
                          progression: 'Aumenta la duraci√≥n. Si llegas a 45s, intenta levantar la pierna de arriba.' }
                    ],
                    final: { type: 'cardio', name: 'Cardio Ligero (Zona 2)', details: 'Realizar 10,000 pasos a lo largo del d√≠a (caminata).' }
                },
                viernes: {
                    dayName: "Viernes",
                    title: "Sesi√≥n HIIT 4x4 (El Complejo) üî•",
                    warmUpType: "hiit",
                    steps: [
                        { type: 'hiit', name: 'HIIT 4x4: "El Complejo"', rounds: 4, workTime: 240, restTime: 180,
                          exercises: [
                              '5 x Peso Muerto Rumano',
                              '5 x Hang Power Clean (Cargada Colgante)',
                              '5 x Sentadilla Frontal',
                              '5 x Push Press'
                          ],
                          progression: 'El objetivo es aumentar la potencia. Registra el n√∫mero total de repeticiones del Complejo completadas en cada sesi√≥n. Si te estancas por 2-3 semanas, considera a√±adir un quinto intervalo.' },
                        { type: 'cooldown', name: 'Vuelta a la Calma', details: '5-10 minutos de estiramientos est√°ticos y movimiento ligero.' }
                    ]
                },
                sabado: {
                    dayName: "S√°bado",
                    title: "D√≠a 4: Cuerpo Completo Funcional üí™",
                    warmUpType: "fuerza",
                    steps: [
                        { type: 'exercise', name: 'Paseo del Granjero (Farmer\'s Walk)', sets: 4, reps: '45 segundos de caminata', rest: 90, 
                          technique: `1. **Preparaci√≥n:** Usa los objetos m√°s pesados que puedas cargar con seguridad. Ejemplo: El saco de 15 kg en una mano y la caja de 20 kg en la otra (si puedes agarrarla) o discos pesados.
2. **Levantamiento:** Levanta las cargas del suelo usando las piernas (como un peso muerto), no la espalda.
3. **Postura:** De pie, mant√©n el pecho erguido, hombros hacia atr√°s y abdomen apretado.
4. **Caminata:** Camina dando pasos cortos y controlados. Lucha por mantenerte totalmente vertical, sin inclinarte hacia un lado.
5. **Objetivo:** Aguanta el agarre y la postura durante el tiempo indicado.`, 
                          progression: 'Aumenta el tiempo de caminata o usa m√°s peso (ej. discos m√°s pesados).' },
                        
                        { type: 'exercise', name: 'Peso Muerto con Barra', sets: 3, reps: '5-8', rest: 120, 
                          technique: `1. **Posici√≥n Inicial:** Coloca la barra cargada en el suelo. Ac√©rcate hasta que tus espinillas casi la toquen. Pies a la anchura de la cadera.
2. **Agarre:** Ag√°chate (empujando cadera atr√°s, espalda recta) y agarra la barra con las manos justo por fuera de tus piernas.
3. **Tensi√≥n:** Mant√©n la espalda *totalmente recta*, el pecho erguido y "tira" de la barra (sin levantarla) para crear tensi√≥n.
4. **Levantamiento:** Empuja el suelo con tus piernas y extiende tu cadera y rodillas al mismo tiempo. La barra debe subir pegada a tus espinillas y muslos.
5. **Final:** Termina de pie, erguido, apretando los gl√∫teos.
6. **Descenso:** Baja la barra de forma controlada, empujando la cadera hacia atr√°s primero y luego doblando las rodillas.`, 
                          progression: 'Aumenta el peso en la barra.' },
                        
                        { type: 'exercise', name: 'Empuje Isom√©trico contra Tanque', sets: 4, reps: '15 segundos de empuje m√°ximo', rest: 60, 
                          technique: `1. **Objeto:** Busca una pared s√≥lida o un objeto que sea imposible de mover (como el "tanque" que mencionas).
2. **Posici√≥n:** Col√≥cate frente a la pared en unaposici√≥n atl√©tica: pies separados, rodillas ligeramente flexionadas, torso inclinado un poco hacia adelante.
3. **Contacto:** Coloca tus manos en la pared a la altura del pecho.
4. **Empuje:** Tensa todo tu cuerpo (abdomen, gl√∫teos, piernas) y empieza a empujar la pared con toda tu fuerza, como si quisieras derribarla.
5. **Intenci√≥n:** Conc√©ntrate en empujar. La fuerza debe venir de tu pecho, hombros y tr√≠ceps, transferida desde tus pies. Mant√©n la tensi√≥n m√°xima durante el tiempo indicado.`, 
                          progression: 'Aumenta la duraci√≥n del empuje. Empuja m√°s fuerte.' },
                        
                        { type: 'exercise', name: 'Burpees (con Chaleco Lastrado)', sets: 3, reps: '8-12', rest: 75, 
                          technique: `1. **Preparaci√≥n:** Ponte el chaleco de 10 kg.
2. **Paso 1 (Cuclillas):** Desde de pie, ag√°chate y pon las manos en el suelo, justo delante de tus pies.
3. **Paso 2 (Plancha):** Salta con ambos pies hacia atr√°s para aterrizar en una posici√≥n de plancha alta.
4. **Paso 3 (Flexi√≥n):** Realiza una flexi√≥n completa, bajando el pecho hasta el suelo.
5. **Paso 4 (Vuelta):** Sube de la flexi√≥n y salta con ambos pies hacia adelante, volviendo a la posici√≥n de cuclillas.
6. **Paso 5 (Salto):** Salta verticalmente lo m√°s alto que puedas, extendiendo los brazos sobre la cabeza. Aterriza y repite.`, 
                          progression: 'Aumenta las repeticiones.' },
                        
                        { type: 'exercise', name: 'Giros Rusos (Russian Twists)', sets: 3, reps: '15-20 por lado', rest: 60, 
                          technique: `1. **Posici√≥n:** Si√©ntate en el suelo. Sost√©n un disco (2.5 o 5 kg) con ambas manos.
2. **Equilibrio:** Inclina tu torso hacia atr√°s unos 45 grados y levanta los pies del suelo. Encuentra el equilibrio sobre tus gl√∫teos. (Si es muy dif√≠cil, apoya los talones).
3. **Giro:** Manteniendo el abdomen apretado, gira tu torso y toca el disco en el suelo a tu lado derecho.
4. **Giro (Otro lado):** Gira completamente hacia el otro lado y toca el suelo a tu lado izquierdo.
5. **Clave:** El movimiento debe venir de la rotaci√≥n de tu torso, no solo de mover los brazos.`, 
                          progression: 'Aumenta las repeticiones o usa un disco m√°s pesado.' }
                    ]
                },
                domingo: {
                    dayName: "Domingo",
                    title: "Descanso Activo (Zona 1) üö∂‚Äç‚ôÇÔ∏è",
                    warmUpType: null,
                    steps: [
                        { type: 'activity', name: 'Caminata Ligera (Zona 1)', details: 'Caminata ligera para recuperaci√≥n.', duration: 3600 } 
                    ]
                }
            }
        };

        // ... (Todo tu JavaScript desde 'let currentDayKey = null;' hasta 'document.addEventListener('DOMContentLoaded', init);' no cambia) ...
        let currentDayKey = null;
        let currentDayData = null;
        let workoutSteps = [];
        let currentStepIndex = 0;
        let currentExerciseSeries = 0; 
        let currentExercisePart = 0; 

        let timerInterval = null;
        let timerSecondsRemaining = 0;
        let timerIsPaused = false;
        let warmupTimerWasPaused = false; 

        let audioCtx; 

        function initAudio() {
            if (!audioCtx && (window.AudioContext || window.webkitAudioContext)) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function createBeep(frequency, duration, startTimeOffset = 0) {
            if (!audioCtx) return; 
            try {
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);

                const startTime = audioCtx.currentTime + startTimeOffset;
                
                oscillator.frequency.setValueAtTime(frequency, startTime);
                gainNode.gain.setValueAtTime(0, startTime);
                gainNode.gain.linearRampToValueAtTime(0.1, startTime + 0.01); 
                
                oscillator.start(startTime);
                oscillator.stop(startTime + duration);
                
                gainNode.gain.setValueAtTime(0.1, startTime + duration - 0.01);
                gainNode.gain.linearRampToValueAtTime(0, startTime + duration);
            } catch (e) {
                console.error("Error al crear beep:", e);
            }
        }

        function playSound(type = 'click') {
            if (!audioCtx) return; 
            
            switch(type) {
                case 'click':
                    createBeep(300, 0.05);
                    break;
                case 'start':
                    createBeep(400, 0.1, 0);
                    createBeep(600, 0.1, 0.12);
                    break;
                case 'pause':
                    createBeep(600, 0.1, 0);
                    createBeep(400, 0.1, 0.12);
                    break;
                case 'part': 
                    createBeep(700, 0.15);
                    break;
                case 'complete': 
                    createBeep(880, 0.1, 0);
                    createBeep(880, 0.1, 0.15);
                    break;
                case 'final': 
                    createBeep(523, 0.1, 0);    
                    createBeep(659, 0.1, 0.15); 
                    createBeep(784, 0.15, 0.3); 
                    break;
                default:
                    createBeep(300, 0.05);
            }
        }

        function playVibration(type = 'click') {
            if (navigator.vibrate) {
                const vibrationMap = {
                    'click': [50],                   
                    'start': [100],                  
                    'pause': [100],                  
                    'part': [150],                   
                    'complete': [200, 50, 200],      
                    'final': [500, 100, 500]       
                };
                if (vibrationMap[type]) {
                    try {
                        navigator.vibrate(vibrationMap[type]);
                    } catch (e) {
                        console.error("Error al vibrar:", e);
                    }
                }
            }
        }

        function playFeedback(type) {
            initAudio(); 
            playSound(type);
            playVibration(type);
        }
        
        const daySelectorView = document.getElementById('day-selector');
        const workoutStepperView = document.getElementById('workout-stepper');
        const hiitWorkoutView = document.getElementById('hiit-workout-view');
        const stepContent = document.getElementById('step-content'); 
        const dayButtons = document.querySelectorAll('.day-card');
        
        const backToMenuBtn = document.getElementById('back-to-menu');
        const workoutTitle = document.getElementById('workout-title');
        const stepProgress = document.getElementById('step-progress');
        
        const stepTitle = document.getElementById('step-title');
        const stepDetails = document.getElementById('step-details');
        
        const durationTimerBlock = document.getElementById('duration-timer-block');
        const durationTimerDisplay = document.getElementById('duration-timer-display');
        const toggleDurationTimerBtn = document.getElementById('toggle-duration-timer');
        const skipDurationTimerBtn = document.getElementById('skip-duration-timer');

        const restTimerBlock = document.getElementById('rest-timer-block');
        const restTimerDisplay = document.getElementById('rest-timer-display');
        const restNextExercise = document.getElementById('rest-next-exercise'); 
        const toggleRestTimerBtn = document.getElementById('toggle-rest-timer');
        const skipRestTimerBtn = document.getElementById('skip-rest-timer');
        
        const techniqueBlock = document.getElementById('technique-block');
        const toggleTechniqueBtn = document.getElementById('toggle-technique');
        const techniqueContent = document.getElementById('technique-content');
        
        const progressionBlock = document.getElementById('progression-block');
        const toggleProgressionBtn = document.getElementById('toggle-progression');
        const progressionContent = document.getElementById('progression-content');
        
        const skipExerciseBlock = document.getElementById('skip-exercise-block');
        const skipExerciseBtn = document.getElementById('skip-exercise-btn');

        const stepNavigation = document.getElementById('step-navigation');
        const prevStepBtn = document.getElementById('prev-step');
        const nextStepBtn = document.getElementById('next-step');

        const hiitRoundInfo = document.getElementById('hiit-round-info');
        const hiitTimerDisplay = document.getElementById('hiit-timer-display');
        const hiitStartPauseBtn = document.getElementById('hiit-start-pause-btn');
        const hiitExercisesList = document.getElementById('hiit-exercises-list');

        const continuousWarmupView = document.getElementById('continuous-warmup-view');
        const warmupProgressText = document.getElementById('warmup-progress-text');
        const warmupProgressBar = document.getElementById('warmup-progress-bar');
        const warmupStepStatus = document.getElementById('warmup-step-status');
        const warmupStepTimerDisplay = document.getElementById('warmup-step-timer-display');
        const warmupStepName = document.getElementById('warmup-step-name');
        const warmupStepDetails = document.getElementById('warmup-step-details');
        const warmupTogglePause = document.getElementById('warmup-toggle-pause');
        const warmupSkipAll = document.getElementById('warmup-skip-all');
        const warmupStepCue = document.getElementById('warmup-step-cue');

        const skipConfirmModal = document.getElementById('skip-confirm-modal');
        const confirmSkipYesBtn = document.getElementById('confirm-skip-yes');
        const confirmSkipNoBtn = document.getElementById('confirm-skip-no');

        // Referencias al modal de finalizaci√≥n
        const completionModal = document.getElementById('completion-modal');
        const completionTitle = document.getElementById('completion-title');
        const completionMessage = document.getElementById('completion-message');
        const closeCompletionModalBtn = document.getElementById('close-completion-modal');

        let warmupQueue = [];
        let currentWarmupStepIdx = 0;
        let totalWarmupSteps = 0;

        let hiitCurrentRound = 0;
        let hiitIsWorkPhase = true;
        let hiitTotalRounds = 0;
        let hiitWorkTime = 0;
        let hiitRestTime = 0;

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        }

        function parseDurationFromReps(repsString) {
            if (!repsString || typeof repsString !== 'string') {
                return null;
            }
            
            if (repsString.includes('segundos')) {
                const match = repsString.match(/(\d+)/); 
                const duration = match ? parseInt(match[1], 10) : null;
                const perSide = /por lado/.test(repsString);
                
                return duration ? { duration, perSide } : null;
            }
            return null;
        }

        function startTimer(durationSeconds, displayElement, onComplete, onTick = null) {
            stopTimer(); 
            timerSecondsRemaining = durationSeconds;
            timerIsPaused = false;
            displayElement.textContent = formatTime(timerSecondsRemaining);

            timerInterval = setInterval(() => {
                if (!timerIsPaused) {
                    timerSecondsRemaining--;
                    displayElement.textContent = formatTime(timerSecondsRemaining);

                    if (onTick) {
                        onTick(timerSecondsRemaining);
                    }

                    if (timerSecondsRemaining <= 0) {
                        stopTimer();
                        if (onComplete) onComplete();
                    }
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            timerInterval = null;
            timerIsPaused = false; 
        }
        
        function init() {
            dayButtons.forEach(button => {
                if (button.dataset.day) {
                    button.addEventListener('click', () => {
                        initAudio(); 
                        playFeedback('click'); 
                        selectDay(button.dataset.day);
                    });
                }
            });

            backToMenuBtn.addEventListener('click', () => {
                playFeedback('click');
                showDaySelectorView();
            });
            prevStepBtn.addEventListener('click', () => {
                playFeedback('click');
                goToPrevStep();
            });
            nextStepBtn.addEventListener('click', () => {
                playFeedback('click');
                handleNextStepAction();
            });

            toggleDurationTimerBtn.addEventListener('click', toggleDurationTimer); 
            skipDurationTimerBtn.addEventListener('click', () => { 
                playFeedback('click');
                stopTimer();
                
                const step = workoutSteps[currentStepIndex];
                const durationInfo = parseDurationFromReps(step.reps);

                if (durationInfo.perSide && currentExercisePart === 0) {
                    currentExercisePart = 1; 
                    renderCurrentStep();
                } else {
                    currentExercisePart = 0; 
                    handleNextStepAction(); 
                }
            });

            toggleRestTimerBtn.addEventListener('click', toggleRestTimer);
            
            skipRestTimerBtn.addEventListener('click', () => {
                playFeedback('click');
                stopTimer();
                
                restTimerBlock.classList.add('hidden');
                stepNavigation.classList.remove('hidden');
                stepContent.classList.remove('hidden'); 
                
                const step = workoutSteps[currentStepIndex];
                if (currentExerciseSeries < step.sets) {
                    currentExerciseSeries++; 
                    renderCurrentStep(); 
                } else {
                    currentExerciseSeries = 0; 
                    goToNextStep();
                }
            });

            toggleTechniqueBtn.addEventListener('click', () => {
                techniqueContent.classList.toggle('visible');
                toggleTechniqueBtn.innerHTML = techniqueContent.classList.contains('visible') ? 'Ocultar T√©cnica &uarr;' : 'Mostrar T√©cnica &darr;';
            });
            
            toggleProgressionBtn.addEventListener('click', () => {
                progressionContent.classList.toggle('visible');
                toggleProgressionBtn.innerHTML = progressionContent.classList.contains('visible') ? 'Ocultar Progresi√≥n &uarr;' : 'Mostrar Progresi√≥n &darr;';
            });

            hiitStartPauseBtn.addEventListener('click', toggleHiitTimer);

            skipExerciseBtn.addEventListener('click', () => {
                playFeedback('click');
                currentExerciseSeries = 0; 
                currentExercisePart = 0; 
                goToNextStep(); 
            });

            warmupTogglePause.addEventListener('click', () => {
                timerIsPaused = !timerIsPaused;
                if (timerIsPaused) {
                    playFeedback('pause');
                    warmupTogglePause.textContent = 'Reanudar';
                    warmupTogglePause.classList.remove('bg-yellow-600', 'shadow-yellow-500/20');
                    warmupTogglePause.classList.add('bg-green-500', 'shadow-green-500/20'); 
                } else {
                    playFeedback('start');
                    warmupTogglePause.textContent = 'Pausar';
                    warmupTogglePause.classList.add('bg-yellow-600', 'shadow-yellow-500/20');
                    warmupTogglePause.classList.remove('bg-green-500', 'shadow-green-500/20');
                }
            });
            
            warmupSkipAll.addEventListener('click', () => {
                playFeedback('click');
                warmupTimerWasPaused = timerIsPaused; 
                if (!timerIsPaused) {
                    timerIsPaused = true;
                    warmupTogglePause.textContent = 'Reanudar';
                    warmupTogglePause.classList.remove('bg-yellow-600', 'shadow-yellow-500/20');
                    warmupTogglePause.classList.add('bg-green-500', 'shadow-green-500/20'); 
                }
                skipConfirmModal.classList.remove('hidden');
            });

            confirmSkipYesBtn.addEventListener('click', () => {
                playFeedback('click');
                skipConfirmModal.classList.add('hidden');
                stopTimer(); 
                endContinuousWarmup(); 
            });

            confirmSkipNoBtn.addEventListener('click', () => {
                playFeedback('click');
                skipConfirmModal.classList.add('hidden');
                if (!warmupTimerWasPaused) {
                    timerIsPaused = false;
                    warmupTogglePause.textContent = 'Pausar';
                    warmupTogglePause.classList.add('bg-yellow-600', 'shadow-yellow-500/20');
                    warmupTogglePause.classList.remove('bg-green-500', 'shadow-green-500/20');
                }
            });

            // Event listener para el bot√≥n del modal de finalizaci√≥n
            closeCompletionModalBtn.addEventListener('click', () => {
                playFeedback('click');
                completionModal.classList.add('hidden');
                showDaySelectorView(); // Vuelve al men√∫ principal
            });
        }

        function selectDay(dayKey) {
            currentDayKey = dayKey;
            currentDayData = allData.days[dayKey];
            
            if (!currentDayData) return;

            workoutSteps = [];
            
            if (currentDayData.warmUpType && allData.warmUps[currentDayData.warmUpType]) {
                workoutSteps.push({ type: 'header', name: '¬°Calentamiento!' });
                workoutSteps.push(...allData.warmUps[currentDayData.warmUpType]);
            }
            
            workoutSteps.push(...currentDayData.steps);
            
            if (currentDayData.final) {
                workoutSteps.push(currentDayData.final);
            }
            
            currentStepIndex = 0;
            currentExerciseSeries = 0;
            currentExercisePart = 0; 
            showWorkoutView(); 
            renderCurrentStep(); 
        }

        function showWorkoutView() {
            daySelectorView.classList.add('hidden');
            workoutStepperView.classList.remove('hidden');
            window.scrollTo(0, 0);
            workoutTitle.textContent = currentDayData.title;
        }

        function showHiitView() {
            stepContent.classList.add('hidden'); 
            hiitWorkoutView.classList.remove('hidden'); 
            stepNavigation.classList.add('hidden'); 
            continuousWarmupView.classList.add('hidden'); 
            window.scrollTo(0, 0);
        }

        function showDaySelectorView() {
            stopTimer();
            hiitStopTimer();

            workoutStepperView.classList.add('hidden');
            daySelectorView.classList.remove('hidden');
        }

        function renderCurrentStep() {
            const step = workoutSteps[currentStepIndex];
            stopTimer(); 
            
            techniqueContent.classList.remove('visible');
            progressionContent.classList.remove('visible');
            toggleTechniqueBtn.innerHTML = 'Mostrar T√©cnica &darr;';
            toggleProgressionBtn.innerHTML = 'Mostrar Progresi√≥n &darr;';
            techniqueBlock.classList.add('hidden');
            progressionBlock.classList.add('hidden');
            durationTimerBlock.classList.add('hidden');
            restTimerBlock.classList.add('hidden'); 
            skipExerciseBlock.classList.add('hidden');
            stepNavigation.classList.remove('hidden'); 
            nextStepBtn.classList.remove('hidden'); 

            hiitWorkoutView.classList.add('hidden'); 
            continuousWarmupView.classList.add('hidden'); 
            stepContent.classList.remove('hidden'); 

            // Asegurarse de que el modal de completado est√© oculto
            completionModal.classList.add('hidden');

            stepProgress.textContent = `Paso ${currentStepIndex + 1} de ${workoutSteps.length}`;
            
            nextStepBtn.textContent = 'Siguiente Paso';
            nextStepBtn.disabled = false;

            switch (step.type) {
                case 'header':
                    stepTitle.textContent = step.name;
                    stepDetails.textContent = (currentDayData.warmUpType === 'fuerza' || currentDayData.warmUpType === 'hiit') 
                        ? 'El siguiente es un calentamiento continuo. Presiona "Siguiente" para comenzar.'
                        : 'Prep√°rate para el calentamiento.';
                    break;
                case 'warmup':
                    stepTitle.textContent = `Calentamiento: ${step.name}`;
                    stepDetails.textContent = step.details;
                    break;
                case 'exercise':
                    if (currentExerciseSeries === 0) currentExerciseSeries = 1; 
                    stepTitle.textContent = `Ejercicio: ${step.name}`;

                    techniqueBlock.classList.remove('hidden');
                    techniqueContent.textContent = step.technique;
                    if (step.progression) {
                        progressionBlock.classList.remove('hidden');
                        progressionContent.textContent = step.progression;
                    }
                    skipExerciseBlock.classList.remove('hidden');

                    const durationInfo = parseDurationFromReps(step.reps);

                    if (!durationInfo) {
                        stepDetails.textContent = `Serie ${currentExerciseSeries} de ${step.sets} | Reps: ${step.reps}`;
                        if (currentExerciseSeries < step.sets) {
                            nextStepBtn.textContent = 'Serie Terminada';
                        } else {
                            nextStepBtn.textContent = 'Ejercicio Terminado';
                        }
                    } else {
                        nextStepBtn.classList.add('hidden'); 
                        durationTimerBlock.classList.remove('hidden');

                        let duration = durationInfo.duration;
                        timerSecondsRemaining = duration;
                        durationTimerDisplay.textContent = formatTime(duration);
                        toggleDurationTimerBtn.textContent = 'Iniciar';
                        toggleDurationTimerBtn.disabled = false;

                        if (durationInfo.perSide) {
                            const side = currentExercisePart === 0 ? 'LADO IZQUIERDO' : 'LADO DERECHO';
                            stepDetails.textContent = `Serie ${currentExerciseSeries} de ${step.sets} (${side})`;
                            toggleDurationTimerBtn.textContent = `Iniciar (${side})`;
                            skipDurationTimerBtn.textContent = 'Saltar Lado';
                        } else {
                            stepDetails.textContent = `Serie ${currentExerciseSeries} de ${step.sets} (${step.reps})`;
                            skipDurationTimerBtn.textContent = 'Saltar Serie';
                        }
                    }
                    break;
                case 'activity':
                    stepTitle.textContent = `Actividad: ${step.name}`;
                    stepDetails.textContent = step.details;
                    break;
                case 'hiit':
                    showHiitView(); 
                    setupHiitWorkout(step);
                    return; 
                case 'cardio':
                case 'cooldown':
                    stepTitle.textContent = step.name;
                    stepDetails.textContent = step.details;
                    break;
            }

            prevStepBtn.disabled = (currentStepIndex === 0);
            
            if (currentStepIndex === workoutSteps.length - 1 && (step.type !== 'exercise' || (step.type === 'exercise' && !parseDurationFromReps(step.reps) && currentExerciseSeries === step.sets))) {
                nextStepBtn.textContent = 'Finalizar Rutina ‚úÖ';
            }
        }

        function handleNextStepAction() {
            initAudio(); 
            const step = workoutSteps[currentStepIndex];

            if (step.type === 'header' && (currentDayData.warmUpType === 'fuerza' || currentDayData.warmUpType === 'hiit')) {
                playFeedback('start'); 
                startContinuousWarmup();
                return;
            }

            if (step.type === 'exercise') {
                
                const durationInfo = parseDurationFromReps(step.reps);
                const isLastSet = (currentExerciseSeries === step.sets);
                
                // Si tiene duraci√≥n, no entra aqu√≠, se maneja en 'toggleDurationTimer'
                // Esta l√≥gica es solo para ejercicios de REPS
                if (!durationInfo) {
                    if (step.rest > 0 && !isLastSet) { // Descanso entre series
                        playFeedback('start'); 
                        
                        stepContent.classList.add('hidden');
                        stepNavigation.classList.add('hidden'); 
                        restTimerBlock.classList.remove('hidden');

                        let nextStepText = `Serie ${currentExerciseSeries + 1} de ${step.sets} - ${step.name}`;
                        restNextExercise.textContent = nextStepText;
                        
                        timerSecondsRemaining = step.rest;
                        toggleRestTimerBtn.textContent = 'Pausar'; 
                        toggleRestTimerBtn.disabled = false;
                        
                        startTimer(timerSecondsRemaining, restTimerDisplay, () => {
                            playFeedback('complete'); 
                            
                            restTimerBlock.classList.add('hidden');
                            stepNavigation.classList.remove('hidden');
                            stepContent.classList.remove('hidden'); 
                            
                            currentExerciseSeries++; 
                            renderCurrentStep(); 
                        });
                    } else if (step.rest > 0 && isLastSet) { // Descanso al final del ejercicio
                        playFeedback('start');
                        
                        stepContent.classList.add('hidden');
                        stepNavigation.classList.add('hidden');
                        restTimerBlock.classList.remove('hidden');

                        const nextExercise = workoutSteps.slice(currentStepIndex + 1).find(s => s.type === 'exercise');
                        let nextStepText;
                        if (nextExercise) {
                            nextStepText = `Siguiente: ${nextExercise.name}`;
                        } else {
                            const finalStep = workoutSteps.slice(currentStepIndex + 1).find(s => s.type === 'cooldown' || s.type === 'cardio');
                            nextStepText = finalStep ? `Siguiente: ${finalStep.name}` : "¬°√öltimo descanso!";
                        }
                        restNextExercise.textContent = nextStepText;
                        
                        timerSecondsRemaining = step.rest;
                        toggleRestTimerBtn.textContent = 'Pausar';
                        toggleRestTimerBtn.disabled = false;

                        startTimer(timerSecondsRemaining, restTimerDisplay, () => {
                            playFeedback('complete');
                            
                            restTimerBlock.classList.add('hidden');
                            stepNavigation.classList.remove('hidden');
                            stepContent.classList.remove('hidden');
                            
                            currentExerciseSeries = 0; 
                            goToNextStep();
                        });

                    } else { // Sin descanso (o es la √∫ltima serie sin descanso)
                        if (!isLastSet) {
                            currentExerciseSeries++;
                            renderCurrentStep(); 
                        } else {
                            currentExerciseSeries = 0;
                            goToNextStep();
                        }
                    }
                }
                // Si es un ejercicio por DURACI√ìN, la l√≥gica de 'descanso' se llama
                // desde la funci√≥n 'toggleDurationTimer'
            } else {
                goToNextStep();
            }
        }

        function goToNextStep() {
            stopTimer();
            if (currentStepIndex < workoutSteps.length - 1) {
                currentStepIndex++;
                renderCurrentStep();
            } else {
                // L√≥gica de finalizaci√≥n con Modal
                playFeedback('final'); 
                
                // Personalizar el mensaje
                const dayName = currentDayData.dayName;
                completionTitle.textContent = `¬°${dayName} Completado! üèÜ`;
                completionMessage.textContent = "¬°Excelente trabajo! Has terminado la rutina de hoy. Descansa y recup√©rate.";

                // Mostrar el modal
                completionModal.classList.remove('hidden');
                
                // Ya no llamamos a showDaySelectorView() aqu√≠. 
                // El bot√≥n del modal lo har√°.
            }
        }

        function goToPrevStep() {
            stopTimer();
            hiitStopTimer();

            if (currentStepIndex > 0) {
                currentStepIndex--;
                currentExerciseSeries = 0; 
                currentExercisePart = 0; 
                renderCurrentStep();
            }
        }

        function toggleDurationTimer() {
            initAudio();
            if (timerInterval) { 
                timerIsPaused = !timerIsPaused;
                toggleDurationTimerBtn.textContent = timerIsPaused ? 'Reanudar' : 'Pausar';
                if(timerIsPaused) playFeedback('pause'); else playFeedback('start');
            } else { 
                playFeedback('start');
                toggleDurationTimerBtn.textContent = 'Pausar';
                startTimer(timerSecondsRemaining, durationTimerDisplay, () => {
                    const step = workoutSteps[currentStepIndex];
                    const durationInfo = parseDurationFromReps(step.reps);

                    if (durationInfo.perSide && currentExercisePart === 0) {
                        playFeedback('part'); 
                        currentExercisePart = 1; 
                        renderCurrentStep(); 
                    } else {
                        playFeedback('complete'); 
                        currentExercisePart = 0; 
                        
                        // Ahora, manejamos el descanso DESPU√âS de un ejercicio por tiempo
                        const isLastSet = (currentExerciseSeries === step.sets);
                        
                        if (step.rest > 0 && !isLastSet) { // Descanso entre series
                            stepContent.classList.add('hidden');
                            stepNavigation.classList.add('hidden'); 
                            durationTimerBlock.classList.add('hidden');
                            restTimerBlock.classList.remove('hidden');

                            let nextStepText = `Serie ${currentExerciseSeries + 1} de ${step.sets} - ${step.name}`;
                            restNextExercise.textContent = nextStepText;
                            
                            timerSecondsRemaining = step.rest;
                            toggleRestTimerBtn.textContent = 'Pausar'; 
                            toggleRestTimerBtn.disabled = false;
                            
                            startTimer(timerSecondsRemaining, restTimerDisplay, () => {
                                playFeedback('complete');
                                restTimerBlock.classList.add('hidden');
                                stepNavigation.classList.remove('hidden');
                                stepContent.classList.remove('hidden'); 
                                
                                currentExerciseSeries++; 
                                renderCurrentStep(); 
                            });
                        } else if (step.rest > 0 && isLastSet) { // Descanso al final del ejercicio
                             stepContent.classList.add('hidden');
                            stepNavigation.classList.add('hidden');
                            durationTimerBlock.classList.add('hidden');
                            restTimerBlock.classList.remove('hidden');

                            const nextExercise = workoutSteps.slice(currentStepIndex + 1).find(s => s.type === 'exercise');
                            let nextStepText;
                            if (nextExercise) {
                                nextStepText = `Siguiente: ${nextExercise.name}`;
                            } else {
                                const finalStep = workoutSteps.slice(currentStepIndex + 1).find(s => s.type === 'cooldown' || s.type === 'cardio');
                                nextStepText = finalStep ? `Siguiente: ${finalStep.name}` : "¬°√öltimo descanso!";
                            }
                            restNextExercise.textContent = nextStepText;
                            
                            timerSecondsRemaining = step.rest;
                            toggleRestTimerBtn.textContent = 'Pausar';
                            toggleRestTimerBtn.disabled = false;

                            startTimer(timerSecondsRemaining, restTimerDisplay, () => {
                                playFeedback('complete');
                                restTimerBlock.classList.add('hidden');
                                stepNavigation.classList.remove('hidden');
                                stepContent.classList.remove('hidden');
                                
                                currentExerciseSeries = 0; 
                                goToNextStep();
                            });
                        } else { // Sin descanso
                             if (!isLastSet) {
                                currentExerciseSeries++;
                                renderCurrentStep(); 
                            } else {
                                currentExerciseSeries = 0;
                                goToNextStep();
                            }
                        }
                    }
                });
            }
        }

        function toggleRestTimer() {
            initAudio();
            if (timerInterval) { 
                timerIsPaused = !timerIsPaused;
                toggleRestTimerBtn.textContent = timerIsPaused ? 'Reanudar' : 'Pausar';
                if(timerIsPaused) playFeedback('pause'); else playFeedback('start');
            }
        }

        function startContinuousWarmup() {
            warmupQueue = workoutSteps.filter(s => s.type === 'warmup');
            totalWarmupSteps = warmupQueue.length;
            currentWarmupStepIdx = 0;
            
            timerIsPaused = false;
            warmupTogglePause.textContent = 'Pausar';
            warmupTogglePause.classList.add('bg-yellow-600', 'shadow-yellow-500/20');
            warmupTogglePause.classList.remove('bg-green-500', 'shadow-green-500/20');

            stepContent.classList.add('hidden');
            stepNavigation.classList.add('hidden');
            continuousWarmupView.classList.remove('hidden');

            runWarmupStep(currentWarmupStepIdx);
        }

        function runWarmupStep(index) {
            if (index >= totalWarmupSteps) {
                endContinuousWarmup();
                return;
            }

            const step = warmupQueue[index];
            
            warmupProgressText.textContent = `Calentamiento (Paso ${index + 1} de ${totalWarmupSteps})`;
            warmupProgressBar.style.width = `${((index) / totalWarmupSteps) * 100}%`;

            if (!step.parts || step.parts.length === 0) {
                warmupStepStatus.textContent = "¬°Prep√°rate! ‚è±Ô∏è";
                warmupStepStatus.classList.remove('text-green-400');
                warmupStepStatus.classList.add('text-yellow-400');
                warmupStepName.textContent = `Siguiente: ${step.name}`;
                warmupStepDetails.textContent = step.details;
                warmupStepCue.textContent = step.cue;
                
                startTimer(step.transition, warmupStepTimerDisplay, () => {
                    warmupStepStatus.textContent = "¬°VAMOS! üí™";
                    warmupStepStatus.classList.remove('text-yellow-400');
                    warmupStepStatus.classList.add('text-green-400');
                    warmupStepName.textContent = step.name;
                    warmupStepCue.textContent = step.cue;
                    warmupProgressBar.style.width = `${((index + 0.5) / totalWarmupSteps) * 100}%`;

                    startTimer(step.duration, warmupStepTimerDisplay, () => {
                        playFeedback('complete'); 
                        runWarmupStep(index + 1);
                    });
                });
            } else {
                runWarmupStepPart(step, 0, index);
            }
        }

        function runWarmupStepPart(step, partIndex, stepIndex) {
            const part = step.parts[partIndex];
            const isFirstPart = (partIndex === 0);
            const transitionTime = isFirstPart ? step.transition : 2; 

            warmupStepStatus.textContent = "¬°Prep√°rate! ‚è±Ô∏è";
            warmupStepStatus.classList.remove('text-green-400');
            warmupStepStatus.classList.add('text-yellow-400');
            warmupStepName.textContent = `${step.name} ${part.name}`; 
            warmupStepDetails.textContent = step.details; 
            warmupStepCue.textContent = part.cue; 
            warmupProgressBar.style.width = `${((stepIndex + (partIndex / step.parts.length)) / totalWarmupSteps) * 100}%`;

            startTimer(transitionTime, warmupStepTimerDisplay, () => {
                warmupStepStatus.textContent = "¬°VAMOS! üí™";
                warmupStepStatus.classList.remove('text-yellow-400');
                warmupStepStatus.classList.add('text-green-400');
                warmupProgressBar.style.width = `${((stepIndex + ((partIndex + 0.5) / step.parts.length)) / totalWarmupSteps) * 100}%`;

                startTimer(part.duration, warmupStepTimerDisplay, () => {
                    if (partIndex + 1 < step.parts.length) {
                        playFeedback('part'); 
                        runWarmupStepPart(step, partIndex + 1, stepIndex);
                    } else {
                        playFeedback('complete'); 
                        runWarmupStep(stepIndex + 1);
                    }
                });
            });
        }


        function endContinuousWarmup() {
            continuousWarmupView.classList.add('hidden');
            
            const firstExerciseIndex = workoutSteps.findIndex(step => step.type !== 'warmup' && step.type !== 'header');

            if (firstExerciseIndex !== -1) {
                currentStepIndex = firstExerciseIndex;
                renderCurrentStep();
            } else {
                // Se reemplaza alert()
                console.log('¬°Calentamiento completado!');
                showDaySelectorView();
            }
        }


        function setupHiitWorkout(step) {
            hiitTotalRounds = step.rounds;
            hiitWorkTime = step.workTime;
            hiitRestTime = step.restTime;
            
            hiitCurrentRound = 1;
            hiitIsWorkPhase = true;
            timerIsPaused = true; 
            
            hiitRoundInfo.textContent = `Ronda ${hiitCurrentRound} de ${hiitTotalRounds}: Trabajo`;
            hiitTimerDisplay.textContent = formatTime(hiitWorkTime);
            hiitStartPauseBtn.textContent = 'Iniciar HIIT';
            hiitStartPauseBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-500', 'shadow-yellow-500/20');
            hiitStartPauseBtn.classList.add('bg-red-600', 'hover:bg-red-500', 'shadow-red-500/20');

            hiitExercisesList.innerHTML = '';
            step.exercises.forEach(exercise => {
                const li = document.createElement('li');
                li.textContent = exercise;
                li.classList.add('whitespace-pre-line'); 
                hiitExercisesList.appendChild(li);
            });
        }

        function toggleHiitTimer() {
            initAudio();
            if (timerInterval) { 
                if (timerIsPaused) {
                    timerIsPaused = false;
                    playFeedback('start'); 
                    hiitStartPauseBtn.textContent = 'Pausar';
                    hiitStartPauseBtn.classList.remove('bg-red-600', 'hover:bg-red-500', 'shadow-red-500/20');
                    hiitStartPauseBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-500', 'shadow-yellow-500/20');
                } else {
                    timerIsPaused = true;
                    playFeedback('pause'); 
                    hiitStartPauseBtn.textContent = 'Reanudar';
                    hiitStartPauseBtn.classList.remove('bg-yellow-600', 'hover:by-yellow-500', 'shadow-yellow-500/20');
                    hiitStartPauseBtn.classList.add('bg-red-600', 'hover:bg-red-500', 'shadow-red-500/20');
                }
            } else { 
                playFeedback('start'); 
                hiitStartPauseBtn.textContent = 'Pausar';
                hiitStartPauseBtn.classList.remove('bg-red-600', 'hover:bg-red-500', 'shadow-red-500/20');
                hiitStartPauseBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-500', 'shadow-yellow-500/20');
                startHiitPhase();
            }
        }

        function startHiitPhase() {
            if (hiitCurrentRound > hiitTotalRounds) {
                playFeedback('final'); // Usar el sonido final aqu√≠ tambi√©n
                
                // Mostrar modal de finalizaci√≥n para HIIT
                completionTitle.textContent = `¬°HIIT Completado! üî•`;
                completionMessage.textContent = "¬°Incre√≠ble sesi√≥n! Has terminado el HIIT de hoy.";
                completionModal.classList.remove('hidden');
                
                // No llamamos a goToNextStep() ni showDaySelectorView()
                // El modal se encargar√°
                return;
            }

            if (hiitIsWorkPhase) {
                hiitRoundInfo.textContent = `Ronda ${hiitCurrentRound} de ${hiitTotalRounds}: ¬°TRABAJO! üî•`;
                hiitTimerDisplay.classList.remove('text-teal-400');
                hiitTimerDisplay.classList.add('text-red-500');
                startTimer(hiitWorkTime, hiitTimerDisplay, () => {
                    playFeedback('complete'); 
                    hiitIsWorkPhase = false;
                    startHiitPhase(); 
                });
            } else {
                hiitRoundInfo.textContent = `Ronda ${hiitCurrentRound} de ${hiitTotalRounds}: Descanso Activo üßò‚Äç‚ôÇÔ∏è`;
                hiitTimerDisplay.classList.remove('text-red-500');
                hiitTimerDisplay.classList.add('text-teal-400');
                startTimer(hiitRestTime, hiitTimerDisplay, () => {
                    playFeedback('part'); 
                    hiitIsWorkPhase = true;
                    hiitCurrentRound++;
                    startHiitPhase(); 
                });
            }
        }

        function hiitStopTimer() {
            stopTimer();
            hiitCurrentRound = 0; 
            hiitIsWorkPhase = true;
        }

        document.addEventListener('DOMContentLoaded', init);

    </script>

    <!-- === SCRIPT PARA REGISTRAR EL SERVICE WORKER === -->
    <script>
        // Registrar el Service Worker para la funcionalidad Offline
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registrado con √©xito:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Fallo en el registro del ServiceWorker:', error);
                    });
            });
        }
    </script>

</body>
</html>


